<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TripSafe – Your Safety, Our Priority</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }
  .trust-card { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  .hidden { display: none; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center bg-slate-100">

<div id="app" class="w-full max-w-sm mx-auto bg-white rounded-3xl trust-card overflow-hidden">

  <!-- Splash -->
  <div id="screen-splash" class="p-8 text-center">
    <h1 class="text-2xl font-bold text-blue-600">TripSafe</h1>
    <p class="text-slate-500 mt-2">Your Safety, Our Priority</p>
    <button onclick="go('login')" class="mt-6 w-full py-3 bg-blue-600 text-white rounded-2xl">Get Started</button>
  </div>

  <!-- Login -->
  <div id="screen-login" class="p-6 hidden">
    <h2 class="text-lg font-bold">Login</h2>
    <form id="loginForm" class="mt-4 space-y-3">
      <input id="loginTouristId" class="w-full border rounded-xl p-3" placeholder="Tourist ID (Mobile)">
      <input id="loginPassword" type="password" class="w-full border rounded-xl p-3" placeholder="Password/OTP">
      <button class="w-full py-3 bg-blue-600 text-white rounded-2xl">Login</button>
    </form>
    <p class="mt-4 text-sm text-slate-500">Don’t have account? 
      <a href="#" onclick="go('signup')" class="text-blue-600">Sign Up</a></p>
  </div>

  <!-- Signup -->
  <div id="screen-signup" class="p-6 hidden">
    <h2 class="text-lg font-bold">Sign Up</h2>
    <form id="signupForm" class="mt-4 space-y-3">
      <input id="suName" class="w-full border rounded-xl p-3" placeholder="Full Name">
      <input id="suFrom" class="w-full border rounded-xl p-3" placeholder="From (City)">
      <input id="suMobile" class="w-full border rounded-xl p-3" placeholder="Mobile Number">
      <input id="suGuardian" class="w-full border rounded-xl p-3" placeholder="Guardian Contact">
      <input id="suOtp" class="w-full border rounded-xl p-3" placeholder="Password/OTP">
      <button class="w-full py-3 bg-blue-600 text-white rounded-2xl">Create Account</button>
    </form>
    <p class="mt-4 text-sm text-slate-500">Already have account? 
      <a href="#" onclick="go('login')" class="text-blue-600">Login</a></p>
  </div>

  <!-- Dashboard -->
  <div id="screen-dashboard" class="p-6 hidden">
    <h2 class="text-lg font-bold">Welcome, <span id="userName"></span></h2>
    <p class="text-sm text-slate-500">From <span id="userFrom"></span></p>
    <div class="mt-4 grid grid-cols-2 gap-3">
      <button onclick="go('feed')" class="p-4 bg-slate-100 rounded-2xl">Safety Feed</button>
      <button onclick="go('chat')" class="p-4 bg-slate-100 rounded-2xl">Chat</button>
      <button onclick="showSOS()" class="p-4 bg-red-100 rounded-2xl text-red-600">SOS</button>
    </div>
  </div>

  <!-- Feed -->
  <div id="screen-feed" class="p-6 hidden">
    <h2 class="text-lg font-bold mb-4">Safety Feed</h2>
    <div id="feedList" class="space-y-3"></div>
    <button onclick="go('dashboard')" class="mt-4 w-full py-3 bg-slate-200 rounded-2xl">Back</button>
  </div>

  <!-- Chat -->
  <div id="screen-chat" class="flex flex-col h-[600px] hidden">
    <div id="chatThread" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
    <form id="chatForm" class="p-3 flex gap-2 border-t">
      <input id="chatInput" class="flex-1 border rounded-xl p-2" placeholder="Type message...">
      <button class="px-4 bg-blue-600 text-white rounded-xl">Send</button>
    </form>
    <button onclick="go('dashboard')" class="m-3 w-full py-2 bg-slate-200 rounded-2xl">Back</button>
  </div>

  <!-- SOS Modal -->
  <div id="modalSOS" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-2xl">
      <p class="mb-4">Send SOS alert with location?</p>
      <div class="flex gap-2">
        <button onclick="hideSOS()" class="flex-1 py-2 rounded-xl border">Cancel</button>
        <button id="sosConfirm" class="flex-1 py-2 bg-red-600 text-white rounded-xl">Send SOS</button>
      </div>
    </div>
  </div>

</div>

<script>
/* -------------------- UI Navigation -------------------- */
function go(screen){
  document.querySelectorAll("#app > div").forEach(el=>el.classList.add("hidden"));
  document.getElementById("screen-"+screen).classList.remove("hidden");
}
function showSOS(){ document.getElementById("modalSOS").classList.remove("hidden"); }
function hideSOS(){ document.getElementById("modalSOS").classList.add("hidden"); }
function toast(msg){ alert(msg); }
function applyUser(u){ userName.textContent=u.name; userFrom.textContent=u.from; }

/* -------------------- Supabase Setup -------------------- */
const SUPABASE_URL = "https://deueiegsmrmxgntqbtdo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRldWVpZWdzbXJteGdudHFidGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTUyODYsImV4cCI6MjA3MzU3MTI4Nn0.W9QJRFcIIRZjpYK6QMyKX83qhNNut4of0P9EMOshtQA";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------- Auth -------------------- */
signupForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = suMobile.value + "@tripsafe.com"; 
  const password = suOtp.value || "defaultPass123";
  const { data, error } = await supabaseClient.auth.signUp({
    email, password,
    options:{ data:{ name:suName.value, from:suFrom.value, guardian:suGuardian.value } }
  });
  if(error) toast(error.message);
  else { applyUser({ name:suName.value, from:suFrom.value }); go("dashboard"); }
});

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = loginTouristId.value + "@tripsafe.com";
  const password = loginPassword.value || "defaultPass123";
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error){ toast(error.message); return; }
  const user = data.user?.user_metadata || { name:"Traveler", from:"Unknown" };
  applyUser(user); go("dashboard");
});

/* -------------------- SOS -------------------- */
sosConfirm.addEventListener("click", async ()=>{
  hideSOS();
  const user = await supabaseClient.auth.getUser();
  const { error } = await supabaseClient.from("sos_alerts").insert([
    { user_id:user.data.user?.id, location:{ lat:18.52, lng:73.85 } }
  ]);
  if(error) toast("Error: "+error.message); else toast("SOS sent!");
});

/* -------------------- Feed -------------------- */
async function loadFeed(){
  const list = document.getElementById("feedList"); list.innerHTML="";
  const { data, error } = await supabaseClient.from("incidents").select("*").order("created_at",{ascending:false});
  if(error){ toast("Error loading feed"); return; }
  data.forEach(item=>{
    const card=document.createElement("div");
    card.className="p-4 rounded-2xl border";
    card.innerHTML=`<div class="font-semibold">${item.title}</div>
                    <p class="text-sm">${item.body}</p>`;
    list.appendChild(card);
  });
}
document.getElementById("screen-feed").addEventListener("show", loadFeed);

/* -------------------- Chat -------------------- */
chatForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const text=chatInput.value.trim(); chatInput.value="";
  const user=await supabaseClient.auth.getUser();
  await supabaseClient.from("messages").insert([{ user_id:user.data.user?.id, text, from_role:"tourist" }]);
});
async function renderChat(){
  const { data } = await supabaseClient.from("messages").select("*").order("created_at",{ascending:true});
  const wrap=document.getElementById("chatThread"); wrap.innerHTML="";
  data.forEach(m=>{
    const mine=m.from_role==="tourist";
    const row=document.createElement("div");
    row.className="flex "+(mine?"justify-end":"justify-start");
    row.innerHTML=`<div class="max-w-[75%] px-3 py-2 rounded-2xl ${mine?'bg-blue-600 text-white':'bg-slate-200'}">
                     ${m.text}</div>`;
    wrap.appendChild(row);
  });
  wrap.scrollTop=wrap.scrollHeight;
}
supabaseClient.channel("messages")
  .on("postgres_changes",{ event:"INSERT", schema:"public", table:"messages" }, ()=>renderChat())
  .subscribe();
</script>

</body>
</html>
