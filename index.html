<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TripSafe – Your Safety, Our Priority</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#1e3a8a;
    --blueLight:#2563eb;
    --green:#10b981;
    --red:#ef4444;
    --ink:#0f172a;
    --bg:#f6f9ff;
  }
  body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a;}
  .trust-card{box-shadow:0 12px 28px rgba(2,6,23,.08);}
  .btn{transition:transform .06s ease, background .2s ease, box-shadow .2s ease}
  .btn:active{transform:translateY(1px)}
  .tile{transition:transform .12s ease, box-shadow .2s ease}
  .tile:active{transform:scale(.99)}
  .pulse-ring{position:absolute;inset:-10px;border-radius:9999px;border:2px solid rgba(239,68,68,.45);animation:ping 1.2s cubic-bezier(0,0,.2,1) infinite}
  @keyframes ping{0%{transform:scale(1);opacity:.9}75%{transform:scale(1.5);opacity:0}100%{transform:scale(1.5);opacity:0}}
  .fade-enter{opacity:0;transform:translateY(8px)}
  .fade-enter-active{opacity:1;transform:translateY(0);transition:all .25s ease}
  .map-hatch{background-image:repeating-linear-gradient(45deg, rgba(239,68,68,.12) 0, rgba(239,68,68,.12) 10px, rgba(239,68,68,.06) 10px, rgba(239,68,68,.06) 20px);}
  .safe-shade{background:rgba(16,185,129,.18);}
  .badge{box-shadow:0 6px 14px rgba(2,6,23,.08);}
  .segmented input:checked + label{background:#fff;color:var(--blue);box-shadow:0 6px 14px rgba(2,6,23,.08)}
  .chat-scroll{scroll-behavior:smooth}
  .call-anim{animation:callPulse 1.4s ease-in-out infinite}
  @keyframes callPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  /* Minimal QR look is SVG-based for robustness */
</style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div id="app" class="w-full max-w-sm mx-auto bg-white rounded-3xl trust-card overflow-hidden">
    <!-- Global Topbar -->
    <header id="topbar" class="hidden px-4 py-3 flex items-center justify-between bg-white border-b border-slate-100">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-xl flex items-center justify-center bg-blue-50 text-blue-700 font-bold">TS</div>
        <span class="text-sm font-semibold text-slate-800">TripSafe</span>
        <span class="ml-2 text-[10px] text-slate-400">Demo</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="langBtn" class="text-xs font-semibold px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 btn">EN</button>
        <button id="offlineToggle" class="text-xs font-semibold px-3 py-1.5 rounded-full bg-green-50 text-green-700 hover:bg-green-100 btn">Online</button>
      </div>
    </header>

    <main id="screens" class="relative">
      <!-- Splash -->
      <section id="screen-splash" class="min-h-[640px] flex flex-col items-center justify-between p-8 bg-white">
        <div></div>
        <div class="text-center">
          <div class="mx-auto mb-6 w-20 h-20 rounded-2xl bg-blue-600 shadow-lg flex items-center justify-center">
            <span class="text-3xl">🛡️</span>
          </div>
          <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">TripSafe</h1>
          <p class="mt-2 text-sm text-slate-600" data-i18n="tagline">Your Safety, Our Priority</p>
          <p class="mt-6 text-xs text-slate-500 max-w-[18rem] mx-auto">Modern, trusted safety companion for tourists.</p>
        </div>
        <div class="w-full">
          <button id="getStarted" class="btn w-full py-3 rounded-2xl bg-blue-600 text-white font-semibold hover:bg-blue-700" data-i18n="getStarted">Get Started</button>
          <p class="text-[11px] text-center text-slate-500 mt-3">By continuing you accept demo terms</p>
        </div>
      </section>

      <!-- Auth -->
      <section id="screen-auth" class="hidden min-h-[640px] p-5 bg-white">
        <div class="text-center mt-3 mb-6">
          <h2 class="text-2xl font-extrabold text-slate-900" data-i18n="welcome">Welcome</h2>
          <p class="text-sm text-slate-500" data-i18n="signinOrCreate">Sign in or create your TripSafe profile</p>
        </div>

        <div class="segmented grid grid-cols-2 bg-slate-100 rounded-xl p-1 mb-5">
          <input type="radio" id="tabLogin" name="authTab" class="hidden" checked>
          <label for="tabLogin" class="text-center text-sm font-semibold py-2 rounded-lg cursor-pointer select-none" data-i18n="login">Login</label>
          <input type="radio" id="tabSignup" name="authTab" class="hidden">
          <label for="tabSignup" class="text-center text-sm font-semibold py-2 rounded-lg cursor-pointer select-none" data-i18n="signup">Sign up</label>
        </div>

        <!-- Login -->
        <form id="loginForm" class="space-y-3">
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">🪪</span>
            <input id="loginTouristId" type="text" placeholder="Tourist ID" class="w-full outline-none text-sm" required>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">🔒</span>
            <input id="loginPassword" type="password" placeholder="Password (or leave empty for OTP)" class="w-full outline-none text-sm">
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <input id="loginOtp" type="checkbox" class="rounded">
              <label for="loginOtp" class="text-xs text-slate-600" data-i18n="useOtp">Use OTP instead</label>
            </div>
            <button type="button" class="text-xs font-semibold text-blue-700">Forgot?</button>
          </div>
          <button type="submit" class="btn w-full py-3 rounded-2xl bg-blue-600 text-white font-semibold hover:bg-blue-700" data-i18n="login">Login</button>
          <button id="loginSendOtp" type="button" class="btn w-full py-3 rounded-2xl bg-blue-50 text-blue-700 font-semibold" data-i18n="sendOtp">Send OTP</button>
        </form>

        <!-- Signup -->
        <form id="signupForm" class="hidden space-y-3 mt-2">
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">👤</span>
            <input id="suName" type="text" placeholder="Full Name" class="w-full outline-none text-sm" required>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">🌍</span>
            <input id="suFrom" type="text" placeholder="From (City / State)" class="w-full outline-none text-sm" required>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 justify-between">
            <div class="flex items-center gap-3">
              <span class="text-xl">🧾</span>
              <span class="text-sm text-slate-700" data-i18n="idUpload">Identity Proof</span>
            </div>
            <button type="button" id="idUpload" class="text-xs font-semibold px-3 py-2 rounded-lg bg-slate-100" data-i18n="upload">Upload</button>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">📱</span>
            <input id="suMobile" type="tel" placeholder="Mobile Number" class="w-full outline-none text-sm" required>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">👨‍👩‍👧</span>
            <input id="suGuardian" type="tel" placeholder="Guardian Contact" class="w-full outline-none text-sm" required>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 justify-between">
            <div class="flex items-center gap-3">
              <span class="text-xl">🤳</span>
              <span class="text-sm text-slate-700" data-i18n="faceVerify">Face Verification</span>
            </div>
            <button type="button" id="faceVerify" class="text-xs font-semibold px-3 py-2 rounded-lg bg-slate-100" data-i18n="start">Start</button>
          </div>
          <div class="flex items-center gap-3 p-3 rounded-xl border border-slate-200">
            <span class="text-xl">🔢</span>
            <div class="flex gap-2 w-full">
              <input id="suOtp" type="text" inputmode="numeric" maxlength="6" placeholder="Enter OTP" class="w-full outline-none text-sm">
              <button type="button" id="sendSignupOtp" class="text-xs font-semibold px-3 py-2 rounded-lg bg-blue-50 text-blue-700" data-i18n="sendOtp">Send OTP</button>
            </div>
          </div>
          <button type="submit" class="btn w-full py-3 rounded-2xl bg-blue-600 text-white font-semibold hover:bg-blue-700" data-i18n="createAccount">Create Account</button>
        </form>

        <p class="text-[11px] text-center text-slate-500 mt-4">Demo only: uploads/selfies mocked.</p>
      </section>

      <!-- Dashboard -->
      <section id="screen-dashboard" class="hidden min-h-[640px] bg-white">
        <div class="relative h-40 bg-slate-100 overflow-hidden">
          <div class="absolute inset-0">
            <div class="absolute inset-0">
              <div class="absolute top-0 left-0 right-0 h-1/2 safe-shade"></div>
              <div class="absolute bottom-0 left-0 right-0 h-1/2 map-hatch"></div>
            </div>
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 400 200" preserveAspectRatio="none">
              <defs>
                <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                  <polygon points="0 0, 6 3, 0 6" fill="#1e40af"></polygon>
                </marker>
              </defs>
              <path d="M20,180 C80,120 160,140 220,110 C280,80 320,60 380,30" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrow)"/>
              <circle cx="20" cy="180" r="6" fill="#10b981"></circle>
              <circle cx="380" cy="30" r="6" fill="#ef4444"></circle>
            </svg>
            <div class="absolute left-6 bottom-8 px-2 py-1 text-[11px] bg-white/90 rounded-md shadow">You are here 📍</div>
            <div class="absolute right-4 top-4 px-2 py-1 text-[11px] bg-white/90 rounded-md shadow">Planned route ➜</div>
          </div>
          <button id="openMap" class="absolute right-3 bottom-3 text-xs font-semibold px-3 py-1.5 rounded-full bg-blue-600 text-white btn" data-i18n="openMap">Open Map</button>
        </div>

        <div class="px-5 py-4">
          <div class="relative mx-auto w-40 h-40">
            <div class="pulse-ring pointer-events-none"></div>
            <button id="sosBtn" class="btn w-full h-full rounded-full bg-red-600 text-white font-extrabold text-3xl shadow-xl hover:bg-red-700 focus:outline-none">SOS</button>
          </div>
          <p class="text-center text-xs text-slate-500 mt-3" data-i18n="sosSub">One tap to alert police and guardians</p>
        </div>

        <div class="grid grid-cols-2 gap-3 px-5">
          <button id="tileEmergency" class="tile p-4 rounded-2xl border border-slate-200 text-left bg-white">
            <div class="text-2xl">🚨</div>
            <div class="mt-2 font-semibold text-slate-800 text-sm" data-i18n="emergencyNumbers">Emergency Numbers</div>
            <div class="text-[11px] text-slate-500">Police • Ambulance • Fire</div>
          </button>

          <div class="tile p-4 rounded-2xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-2xl">🧭</div>
                <div class="mt-2 font-semibold text-slate-800 text-sm" data-i18n="guardianMode">Guardian Mode</div>
                <div class="text-[11px] text-slate-500" data-i18n="familyTracking">Family tracking</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleGuardian" type="checkbox" class="sr-only">
                <span class="w-11 h-6 bg-slate-200 rounded-full relative transition">
                  <span id="guardianKnob" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition"></span>
                </span>
              </label>
            </div>
            <div id="guardianLive" class="hidden mt-3 text-xs text-green-700 bg-green-50 rounded-lg px-2 py-1 badge">Live tracking enabled ✅</div>
          </div>

          <div class="tile p-4 rounded-2xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-2xl">📤</div>
                <div class="mt-2 font-semibold text-slate-800 text-sm" data-i18n="autoShare">Auto Location Share</div>
                <div class="text-[11px] text-slate-500" data-i18n="autoShareSub">Share if no response</div>
              </div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleAutoShare" type="checkbox" class="sr-only">
                <span class="w-11 h-6 bg-slate-200 rounded-full relative transition">
                  <span id="autoShareKnob" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition"></span>
                </span>
              </label>
            </div>
            <div id="autoShareHint" class="hidden mt-3 text-xs text-blue-700 bg-blue-50 rounded-lg px-2 py-1 badge">If no reply in 10 min, location will be sent</div>
          </div>

          <button id="tileSafetyFeed" class="tile p-4 rounded-2xl border border-slate-200 text-left bg-white">
            <div class="text-2xl">📰</div>
            <div class="mt-2 font-semibold text-slate-800 text-sm" data-i18n="safetyFeed">Safety Feed</div>
            <div class="text-[11px] text-slate-500" data-i18n="latestNearby">Latest nearby incidents</div>
          </button>
        </div>

        <!-- Calls tab -->
        <div class="px-5 pt-4 pb-6">
          <div class="p-4 rounded-2xl border border-slate-200 bg-white">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-2xl">📞</span>
                <div>
                  <div class="font-semibold text-slate-800 text-sm">Calls</div>
                  <div class="text-[11px] text-slate-500">Audio / Video</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button id="openAudio" class="px-3 py-1.5 rounded-lg bg-green-600 text-white text-xs font-semibold">Audio</button>
                <button id="openVideo" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-semibold">Video</button>
              </div>
            </div>
          </div>
        </div>

        <div class="px-5 pb-5 flex items-center justify-between text-xs">
          <button id="tileProfile" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">Profile</button>
          <button id="tileAlerts" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">Alerts</button>
          <button id="tileChat" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">Chat</button>
          <div class="text-[11px] text-slate-400">v0.2 Demo</div>
        </div>
      </section>

      <!-- Live Map (Mocked MapLibre view) -->
      <section id="screen-map" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div class="text-sm font-semibold">Live Map</div>
          <div class="text-[11px] text-slate-500">Demo</div>
        </div>
        <div class="relative flex-1">
          <div class="absolute inset-0 bg-slate-100 overflow-hidden">
            <div class="absolute inset-0">
              <div class="absolute inset-6 rounded-3xl safe-shade"></div>
              <div class="absolute left-10 top-16 right-10 bottom-20 rounded-3xl map-hatch"></div>
            </div>
            <span class="absolute left-6 top-6 text-[11px] bg-green-600 text-white px-2 py-0.5 rounded">Safe Zone</span>
            <span class="absolute right-6 bottom-24 text-[11px] bg-red-600 text-white px-2 py-0.5 rounded">High-Risk</span>
            <div class="absolute left-8 bottom-16 px-2 py-1 text-xs bg-white rounded-md shadow">🏥 Hospital</div>
            <div class="absolute right-8 top-28 px-2 py-1 text-xs bg-white rounded-md shadow">👮 Police</div>
            <div class="absolute left-1/2 -translate-x-1/2 top-10 px-2 py-1 text-xs bg-white rounded-md shadow">🚌 Transport</div>
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 400 640" preserveAspectRatio="none">
              <path d="M40,600 C120,520 180,520 240,460 C300,400 340,340 360,200" fill="none" stroke="#2563eb" stroke-width="4" stroke-dasharray="6 6"/>
            </svg>
            <div class="absolute left-9 bottom-12">
              <div class="relative">
                <div class="pulse-ring"></div>
                <div class="w-6 h-6 rounded-full bg-blue-600 border-2 border-white shadow"></div>
              </div>
              <div class="mt-1 text-[11px] text-slate-600">You</div>
            </div>
          </div>

          <div id="geofenceBanner" class="hidden absolute left-4 right-4 top-4 bg-red-50 text-red-700 text-xs rounded-xl px-3 py-2 shadow">
            ⚠️ High-Risk Zone detected. Stay alert. Route updated.
          </div>

          <div class="absolute left-4 right-4 bottom-4 grid grid-cols-2 gap-3">
            <button id="simulateFence" class="btn bg-red-600 text-white rounded-xl py-3 font-semibold">Simulate Geo-Fence</button>
            <button id="openIncident" class="btn bg-blue-600 text-white rounded-xl py-3 font-semibold">Area Info</button>
          </div>
        </div>
      </section>

      <!-- Safety Feed -->
      <section id="screen-feed" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div class="text-sm font-semibold">Safety Feed</div>
          <div class="text-[11px] text-slate-500">Live</div>
        </div>
        <div id="feedList" class="p-4 space-y-3">
          <!-- Dynamic via API mock -->
        </div>
      </section>

      <!-- Incident & Area Info -->
      <section id="screen-incident" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="map">← Back</button>
          <div class="text-sm font-semibold">Area Safety</div>
          <div class="text-[11px] text-slate-500">Demo</div>
        </div>
        <div class="p-5 space-y-4">
          <div class="p-4 rounded-2xl bg-slate-50 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-500">Safety Score</div>
                <div id="safetyScore" class="text-2xl font-extrabold text-slate-900">--</div>
              </div>
              <div id="safetyIcon" class="text-green-600 text-xl">🟢</div>
            </div>
            <p class="text-xs text-slate-500 mt-2">AI-based rating from recent reports</p>
          </div>

          <div class="space-y-2">
            <h3 class="text-sm font-bold text-slate-800">Recent Incidents</h3>
            <div id="incidentList" class="space-y-2 max-h-40 overflow-auto pr-1"></div>
          </div>

          <div class="space-y-2">
            <h3 class="text-sm font-bold text-slate-800">Tourist Info</h3>
            <ul class="text-xs text-slate-600 list-disc pl-5 space-y-1" id="touristTips">
              <!-- Tips populated -->
            </ul>
          </div>

          <button id="toProfileFromIncident" class="btn w-full py-3 rounded-xl bg-slate-100 font-semibold">View My Profile</button>
        </div>
      </section>

      <!-- Profile -->
      <section id="screen-profile" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div class="text-sm font-semibold">My Profile</div>
          <div class="text-[11px] text-slate-500">ID</div>
        </div>
        <div class="p-5 space-y-4">
          <div class="flex items-center gap-3">
            <div class="w-14 h-14 rounded-2xl bg-blue-100 flex items-center justify-center text-2xl" id="profilePhoto">🙂</div>
            <div>
              <div class="font-bold text-slate-800" id="profileName">Alex Traveler</div>
              <div class="text-xs text-slate-500" id="profileFrom">From: Pune, Maharashtra</div>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold text-slate-800">Digital Tourist ID</div>
              <span class="text-xs text-slate-500">QR</span>
            </div>
            <div class="mt-3 flex items-center justify-center">
              <svg width="140" height="140" viewBox="0 0 100 100" class="rounded-lg border border-slate-200">
                <rect width="100" height="100" fill="#fff"/>
                <rect x="6" y="6" width="24" height="24" fill="#111827"/>
                <rect x="70" y="6" width="24" height="24" fill="#111827"/>
                <rect x="6" y="70" width="24" height="24" fill="#111827"/>
                <rect x="36" y="36" width="6" height="6" fill="#111827"/>
                <rect x="46" y="36" width="8" height="8" fill="#111827"/>
                <rect x="60" y="36" width="6" height="6" fill="#111827"/>
                <rect x="36" y="48" width="6" height="6" fill="#111827"/>
                <rect x="52" y="52" width="14" height="14" fill="#111827"/>
                <rect x="36" y="60" width="6" height="6" fill="#111827"/>
                <rect x="60" y="60" width="6" height="6" fill="#111827"/>
                <rect x="80" y="48" width="6" height="6" fill="#111827"/>
                <rect x="48" y="80" width="10" height="10" fill="#111827"/>
              </svg>
            </div>
            <p class="text-center text-[11px] text-slate-500 mt-2">Show this to authorities if needed</p>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200 space-y-2">
            <div class="text-sm font-bold text-slate-800">Emergency Contacts</div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-700">Parent</span>
              <button class="px-3 py-1.5 rounded-lg bg-slate-100 text-xs font-semibold">Call</button>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-slate-700">Relative</span>
              <button class="px-3 py-1.5 rounded-lg bg-slate-100 text-xs font-semibold">Call</button>
            </div>
          </div>

          <div class="p-4 rounded-2xl border border-slate-200 space-y-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold text-slate-800">Language</div>
              <button id="profileLang" class="px-3 py-1.5 rounded-lg bg-slate-100 text-xs font-semibold">EN</button>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold text-slate-800">Check-in Reminders</div>
              <label class="inline-flex items-center cursor-pointer">
                <input id="toggleCheckin" type="checkbox" class="sr-only">
                <span class="w-11 h-6 bg-slate-200 rounded-full relative transition">
                  <span id="checkinKnob" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition"></span>
                </span>
              </label>
            </div>
            <div id="checkinHint" class="hidden text-xs text-green-700 bg-green-50 rounded-lg px-2 py-1 badge">Daily check-in at 8pm enabled</div>
          </div>
        </div>
      </section>

      <!-- Alerts -->
      <section id="screen-alerts" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div class="text-sm font-semibold">Alerts</div>
          <div class="text-[11px] text-slate-500">Demo</div>
        </div>
        <div id="alertsList" class="p-4 space-y-3">
          <!-- dynamic -->
        </div>
      </section>

      <!-- Chat (Tourist ↔ Guardian) -->
      <section id="screen-chat" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div class="text-sm font-semibold">Guardian Chat</div>
          <div class="text-[11px] text-slate-500">Demo</div>
        </div>
        <div id="chatThread" class="flex-1 p-4 space-y-2 overflow-auto chat-scroll bg-slate-50"></div>
        <form id="chatForm" class="p-3 flex items-center gap-2 border-t border-slate-100">
          <input id="chatInput" class="flex-1 px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm outline-none" placeholder="Type a message...">
          <button class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold btn">Send</button>
        </form>
      </section>

      <!-- Calls UI -->
      <section id="screen-call" class="hidden min-h-[640px] flex flex-col bg-white">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
          <button class="text-sm font-semibold px-3 py-1.5 rounded-full bg-slate-100" data-back="dashboard">← Back</button>
          <div id="callTitle" class="text-sm font-semibold">Audio Call</div>
          <div class="text-[11px] text-slate-500">Demo</div>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center p-6">
          <div id="videoPreview" class="hidden w-64 h-40 rounded-2xl bg-slate-200 mb-6 flex items-center justify-center text-slate-600">Video Preview</div>
          <div class="w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center text-4xl call-anim">👤</div>
          <div class="mt-3 text-sm text-slate-600">Calling Guardian...</div>
          <div class="mt-6 flex gap-3">
            <button id="btnMute" class="px-4 py-2 rounded-full bg-slate-100 font-semibold btn">Mute</button>
            <button id="btnCam" class="hidden px-4 py-2 rounded-full bg-slate-100 font-semibold btn">Camera Off</button>
            <button id="btnEnd" class="px-4 py-2 rounded-full bg-red-600 text-white font-semibold btn">End</button>
          </div>
        </div>
      </section>

      <!-- AI Safety Bot -->
      <button id="botFab" class="fixed bottom-6 right-6 z-10 translate-x-[-24px] sm:translate-x-0 px-4 py-3 rounded-full bg-blue-600 text-white shadow-lg btn">🤖</button>
      <div id="botPanel" class="hidden absolute inset-0 bg-black/30 flex items-end p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl overflow-hidden trust-card">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
            <div class="font-semibold">Ask TripSafe Bot</div>
            <button id="botClose" class="text-xs px-2 py-1.5 rounded-lg bg-slate-100">✕</button>
          </div>
          <div id="botMessages" class="h-72 overflow-auto p-3 space-y-2 bg-slate-50 chat-scroll">
            <div class="text-xs text-slate-600">Hi! Ask me safety tips, translate phrases, or say “I’m lost”.</div>
          </div>
          <form id="botForm" class="p-3 flex items-center gap-2 border-t border-slate-100">
            <select id="botLang" class="px-2 py-2 rounded-lg bg-white border border-slate-200 text-xs">
              <option value="EN">EN</option>
              <option value="HI">HI</option>
            </select>
            <input id="botInput" class="flex-1 px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm outline-none" placeholder="Type your question...">
            <button class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold btn">Ask</button>
          </form>
        </div>
      </div>

      <!-- Modals -->
      <div id="modalEmergency" class="hidden absolute inset-0 bg-black/40 flex items-end sm:items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-slate-800">Emergency Numbers</div>
            <button id="closeEmergency" class="text-xs px-2 py-1.5 rounded-lg bg-slate-100">✕</button>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <button class="p-3 rounded-xl bg-red-50 text-red-700 text-sm font-semibold call-number" data-target="police">Police</button>
            <button class="p-3 rounded-xl bg-red-50 text-red-700 text-sm font-semibold call-number" data-target="ambulance">Ambulance</button>
            <button class="p-3 rounded-xl bg-red-50 text-red-700 text-sm font-semibold call-number" data-target="fire">Fire</button>
          </div>
          <p class="text-[11px] text-slate-500">Demo only: calls mocked.</p>
        </div>
      </div>

      <div id="modalSOS" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-2xl p-5 space-y-3">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-red-600 text-white flex items-center justify-center text-xl">🚨</div>
            <div>
              <div class="font-bold text-slate-900">SOS Activated</div>
              <div class="text-xs text-slate-600">Calling police... sharing location</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="sosCancel" class="btn py-2 rounded-xl bg-slate-100 font-semibold">Cancel</button>
            <button id="sosConfirm" class="btn py-2 rounded-xl bg-red-600 text-white font-semibold">Confirm</button>
          </div>
          <p class="text-[11px] text-slate-500">Demo only: no real calls.</p>
        </div>
      </div>

      <!-- Toast -->
      <div id="toast" class="hidden absolute left-1/2 -translate-x-1/2 bottom-5 bg-slate-900 text-white text-xs px-3 py-2 rounded-full shadow-lg"></div>
    </main>
  </div>

<script>
/* -------------------- i18n (EN, HI) -------------------- */
const i18n = {
  EN: {
    tagline: "Your Safety, Our Priority",
    getStarted: "Get Started",
    welcome: "Welcome",
    signinOrCreate: "Sign in or create your TripSafe profile",
    login: "Login",
    signup: "Sign up",
    sendOtp: "Send OTP",
    idUpload: "Identity Proof",
    upload: "Upload",
    faceVerify: "Face Verification",
    start: "Start",
    createAccount: "Create Account",
    useOtp: "Use OTP instead",
    openMap: "Open Map",
    sosSub: "One tap to alert police and guardians",
    emergencyNumbers: "Emergency Numbers",
    guardianMode: "Guardian Mode",
    familyTracking: "Family tracking",
    autoShare: "Auto Location Share",
    autoShareSub: "Share if no response",
    safetyFeed: "Safety Feed",
    latestNearby: "Latest nearby incidents",
  },
  HI: {
    tagline: "आपकी सुरक्षा, हमारी प्राथमिकता",
    getStarted: "शुरू करें",
    welcome: "स्वागत है",
    signinOrCreate: "साइन इन करें या प्रोफ़ाइल बनाएं",
    login: "लॉगिन",
    signup: "साइन अप",
    sendOtp: "ओटीपी भेजें",
    idUpload: "पहचान पत्र",
    upload: "अपलोड",
    faceVerify: "चेहरा सत्यापन",
    start: "शुरू करें",
    createAccount: "खाता बनाएं",
    useOtp: "ओटीपी का उपयोग करें",
    openMap: "मानचित्र खोलें",
    sosSub: "एक टैप में पुलिस और अभिभावकों को सूचित करें",
    emergencyNumbers: "आपातकालीन नंबर",
    guardianMode: "गार्डियन मोड",
    familyTracking: "परिवार ट्रैकिंग",
    autoShare: "ऑटो लोकेशन शेयर",
    autoShareSub: "कोई जवाब न हो तो साझा करें",
    safetyFeed: "सुरक्षा फीड",
    latestNearby: "नज़दीकी घटनाएँ",
  }
};
let currentLang = "EN";
function applyI18n() {
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(i18n[currentLang][key]) el.textContent = i18n[currentLang][key];
  });
  document.getElementById("langBtn").textContent = currentLang;
  const profileLang = document.getElementById("profileLang");
  if (profileLang) profileLang.textContent = currentLang;
}

/* -------------------- Mock API Layer + Offline Fallback -------------------- */
/*
 Replaces real endpoints with local handlers.
 If offlineMode = true, APIs fail and we simulate SMS fallback for SOS.
*/
let offlineMode = false;

const mockDB = {
  user: { name: "Alex Traveler", from: "Pune, Maharashtra" },
  feed: [
    { id:1, title:"Police advisory: crowded market today", date:"12 Aug", body:"Keep belongings close. Follow signage."},
    { id:2, title:"Traffic diversion on Central Ave", date:"11 Aug", body:"Expect delays; route adjusted in map."},
    { id:3, title:"Community event near Riverfront", date:"10 Aug", body:"Large crowds expected. Use east gate."},
  ],
  incidents: [
    { id:11, type:"Minor Theft", date:"12 Aug", level:"Low" },
    { id:12, type:"Road Protest", date:"10 Aug", level:"High" },
    { id:13, type:"Lost Item", date:"07 Aug", level:"Info" },
  ],
  messages: [
    { id:101, from:"guardian", text:"Reached hotel?", ts: Date.now()-1000*60*12, read:true },
  ]
};

const api = {
  async call(url, options={}){
    if(offlineMode) throw new Error("offline");
    // Simple router
    await sleep(400);
    const { method="GET" } = options;
    if (url.startsWith("/api/auth/login") && method==="POST") {
      return { ok:true, json: async ()=>({ token:"demo-token", user: mockDB.user }) };
    }
    if (url.startsWith("/api/auth/signup") && method==="POST") {
      return { ok:true, json: async ()=>({ token:"demo-token", user: mockDB.user }) };
    }
    if (url.startsWith("/api/sos") && method==="POST") {
      return { ok:true, json: async ()=>({ status:"sent", notified:["police","guardian"] }) };
    }
    if (url.startsWith("/api/messages") && method==="GET") {
      return { ok:true, json: async ()=>({ items: mockDB.messages }) };
    }
    if (url.startsWith("/api/messages") && method==="POST") {
      const payload = JSON.parse(options.body||"{}");
      const msg = { id: Date.now(), from:"you", text: payload.text||"", ts: Date.now(), read:false };
      mockDB.messages.push(msg);
      // Echo from guardian
      setTimeout(()=> {
        mockDB.messages.push({ id: Date.now()+1, from:"guardian", text:"👍", ts: Date.now()+1000, read:false });
        renderChat();
      }, 900);
      return { ok:true, json: async ()=>({ sent:true }) };
    }
    if (url.startsWith("/api/call") && method==="POST") {
      return { ok:true, json: async ()=>({ status:"signaling-ok" }) };
    }
    if (url.startsWith("/api/ai-bot") && method==="POST") {
      const payload = JSON.parse(options.body||"{}");
      const reply = botLogic(payload.text||"", payload.lang||"EN");
      return { ok:true, json: async ()=>({ reply }) };
    }
    if (url.startsWith("/api/feed") && method==="GET") {
      return { ok:true, json: async ()=>({ items: mockDB.feed }) };
    }
    if (url.startsWith("/api/area") && method==="GET") {
      const score = 4.2;
      return { ok:true, json: async ()=>({ score, incidents: mockDB.incidents, tips: [
        "Respect local dress codes at religious places.",
        "Avoid isolated areas after dark; prefer main roads.",
        "Keep emergency contacts quick-dial ready.",
        "Carry a copy of ID; keep originals safe."
      ]}) };
    }
    return { ok:false, json: async ()=>({ error:"not-found" }) };
  }
};

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* -------------------- Helpers -------------------- */
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));
function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function toast(msg){ const t=$("#toast"); t.textContent=msg; show(t); setTimeout(()=>hide(t), 2200); }

/* -------------------- Navigation -------------------- */
const screens = {
  splash: $("#screen-splash"),
  auth: $("#screen-auth"),
  dashboard: $("#screen-dashboard"),
  map: $("#screen-map"),
  feed: $("#screen-feed"),
  incident: $("#screen-incident"),
  profile: $("#screen-profile"),
  alerts: $("#screen-alerts"),
  chat: $("#screen-chat"),
  call: $("#screen-call"),
};
const topbar = $("#topbar");
function go(name){
  Object.values(screens).forEach(s=>hide(s));
  show(screens[name]);
  if (name==="splash"||name==="auth"){ hide(topbar); } else { show(topbar); }
  screens[name].classList.add("fade-enter");
  setTimeout(()=>{ screens[name].classList.add("fade-enter-active");
    setTimeout(()=>screens[name].classList.remove("fade-enter","fade-enter-active"),260);
  },10);
}

/* -------------------- Init -------------------- */
go("splash");
applyI18n();

/* -------------------- Splash -------------------- */
$("#getStarted").addEventListener("click", ()=> go("auth"));

/* -------------------- Auth -------------------- */
const tabLogin=$("#tabLogin"), tabSignup=$("#tabSignup");
const loginForm=$("#loginForm"), signupForm=$("#signupForm");
function switchAuth(){
  if (tabLogin.checked){ show(loginForm); hide(signupForm); }
  else { hide(loginForm); show(signupForm); }
}
switchAuth();
tabLogin.addEventListener("change", switchAuth);
tabSignup.addEventListener("change", switchAuth);

$("#loginSendOtp").addEventListener("click", ()=> toast("OTP sent (demo)"));
$("#idUpload").addEventListener("click", ()=> toast("ID uploaded (demo)"));
$("#faceVerify").addEventListener("click", ()=> toast("Face verified (demo)"));
$("#sendSignupOtp").addEventListener("click", ()=> toast("OTP sent (demo)"));

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{
    const res = await api.call("/api/auth/login",{ method:"POST", body: JSON.stringify({ id: $("#loginTouristId").value }) });
    if (res.ok){ const data=await res.json(); applyUser(data.user); go("dashboard"); toast("Welcome back!"); }
  }catch(err){
    toast("Offline: using cached profile");
    applyUser(mockDB.user);
    go("dashboard");
  }
});
signupForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  try{
    const res = await api.call("/api/auth/signup",{ method:"POST", body: JSON.stringify({ name: $("#suName").value }) });
    if (res.ok){ const data=await res.json(); applyUser(data.user); go("dashboard"); toast("Account created!"); }
  }catch(err){
    toast("Offline: profile saved locally");
    applyUser({ name: $("#suName").value, from: $("#suFrom").value });
    go("dashboard");
  }
});
function applyUser(u){
  $("#profileName").textContent = u.name || "Traveler";
  $("#profileFrom").textContent = "From: " + (u.from||"-");
}

/* -------------------- Language -------------------- */
function cycleLang(){ currentLang = currentLang==="EN"?"HI":"EN"; applyI18n(); }
$("#langBtn").addEventListener("click", cycleLang);
$("#profileLang").addEventListener("click", cycleLang);

/* -------------------- Offline Toggle -------------------- */
$("#offlineToggle").addEventListener("click", ()=>{
  offlineMode = !offlineMode;
  const b = $("#offlineToggle");
  if (offlineMode){ b.textContent="Offline"; b.className="text-xs font-semibold px-3 py-1.5 rounded-full bg-red-50 text-red-700 hover:bg-red-100 btn"; toast("Offline mode: SMS fallback enabled"); }
  else { b.textContent="Online"; b.className="text-xs font-semibold px-3 py-1.5 rounded-full bg-green-50 text-green-700 hover:bg-green-100 btn"; toast("Back online"); }
});

/* -------------------- Dashboard actions -------------------- */
$("#openMap").addEventListener("click", ()=> go("map"));
$("#tileSafetyFeed").addEventListener("click", ()=> { loadFeed(); go("feed"); });
$("#tileProfile").addEventListener("click", ()=> go("profile"));
$("#tileAlerts").addEventListener("click", ()=> { loadAlerts(); go("alerts"); });
$("#tileChat").addEventListener("click", ()=> { renderChat(); go("chat"); });

$("#tileEmergency").addEventListener("click", ()=> show($("#modalEmergency")));
$("#closeEmergency").addEventListener("click", ()=> hide($("#modalEmergency")));
$$(".call-number").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    try{
      await api.call("/api/call",{ method:"POST", body: JSON.stringify({ target: btn.dataset.target })});
      toast("Dialling " + btn.dataset.target);
    }catch(e){ toast("Offline: cannot place call"); }
  });
});

/* Guardian toggle */
const toggleGuardian=$("#toggleGuardian"), guardianKnob=$("#guardianKnob"), guardianLive=$("#guardianLive");
toggleGuardian.addEventListener("change", ()=>{
  if (toggleGuardian.checked){
    guardianKnob.style.left='1.375rem';
    guardianKnob.parentElement.style.background='rgba(16,185,129,.9)';
    show(guardianLive);
    toast("Guardian Mode ON");
  }else{
    guardianKnob.style.left='.125rem';
    guardianKnob.parentElement.style.background='';
    hide(guardianLive);
    toast("Guardian Mode OFF");
  }
});

/* Auto share */
const toggleAutoShare=$("#toggleAutoShare"), autoShareKnob=$("#autoShareKnob"), autoShareHint=$("#autoShareHint");
let autoShareTimer=null;
toggleAutoShare.addEventListener("change", ()=>{
  if (toggleAutoShare.checked){
    autoShareKnob.style.left='1.375rem';
    autoShareKnob.parentElement.style.background='rgba(59,130,246,.9)';
    show(autoShareHint);
    toast("Auto Share ON");
    autoShareTimer = setTimeout(()=> {
      if (toggleAutoShare.checked){
        addAlert({ title:"Auto Location Share", ts:"Now", body:"No reply in 10 minutes. Location shared with guardians.", type:"info" });
        go("alerts");
        loadAlerts();
        toast("Location auto-shared");
      }
    }, 10000);
  }else{
    autoShareKnob.style.left='.125rem';
    autoShareKnob.parentElement.style.background='';
    hide(autoShareHint);
    if (autoShareTimer) clearTimeout(autoShareTimer);
    toast("Auto Share OFF");
  }
});

/* SOS Flow */
$("#sosBtn").addEventListener("click", ()=> show($("#modalSOS")));
$("#sosCancel").addEventListener("click", ()=> hide($("#modalSOS")));
$("#sosConfirm").addEventListener("click", async ()=>{
  hide($("#modalSOS"));
  const location = { lat: 18.5204, lng: 73.8567 };
  try{
    const res = await api.call("/api/sos",{ method:"POST", body: JSON.stringify({ location, contacts:["police","guardian"] }) });
    if (res.ok){
      toast("Location Shared with Police + Parents");
      addAlert({ title:"SOS Sent", ts:"Now", body:"Location shared with authorities and guardians.", type:"warn" });
      loadAlerts();
    }
  }catch(e){
    // Offline fallback: SMS simulation
    addAlert({ title:"Offline SOS via SMS", ts:"Now", body:"SMS sent to Police + Guardians with your last known location.", type:"warn" });
    toast("Offline: SMS SOS sent");
    loadAlerts();
  }
});

/* -------------------- Map -------------------- */
$("[data-back='dashboard']").addEventListener("click", ()=> go("dashboard"));
$("#simulateFence").addEventListener("click", ()=>{
  const b=$("#geofenceBanner"); show(b);
  setTimeout(()=> hide(b), 4000);
  addAlert({ title:"Geo-fence Alert", ts:"Now", body:"High-Risk Zone entered. Stay alert.", type:"warn" });
});
$("#openIncident").addEventListener("click", async ()=>{
  await loadAreaInfo();
  go("incident");
});

/* -------------------- Incident & Area Info -------------------- */
async function loadAreaInfo(){
  try{
    const res = await api.call("/api/area?lat=0&lng=0",{ method:"GET" });
    if(!res.ok) throw new Error();
    const data = await res.json();
    $("#safetyScore").textContent = data.score.toFixed(1) + "/5";
    $("#safetyIcon").textContent = data.score >=4 ? "🟢" : data.score >=3 ? "🟡" : "🔴";
    const list=$("#incidentList"); list.innerHTML="";
    data.incidents.forEach(it=>{
      const row = document.createElement("div");
      row.className="p-3 rounded-xl border border-slate-200 flex items-center justify-between";
      row.innerHTML = `<div class="text-xs"><span class="font-semibold">${it.type}</span> • ${it.date}</div>
      <span class="text-xs ${it.level==='High'?'bg-red-50 text-red-700':'bg-yellow-50 text-yellow-700'} px-2 py-0.5 rounded">${it.level}</span>`;
      list.appendChild(row);
    });
    const tips=$("#touristTips"); tips.innerHTML="";
    data.tips.forEach(t=>{ const li=document.createElement("li"); li.textContent=t; tips.appendChild(li); });
  }catch(e){
    $("#safetyScore").textContent = "3.8/5";
  }
}
$("#toProfileFromIncident").addEventListener("click", ()=> go("profile"));

/* -------------------- Feed -------------------- */
async function loadFeed(){
  const list = $("#feedList"); list.innerHTML="";
  try{
    const res = await api.call("/api/feed",{ method:"GET" });
    const data = await res.json();
    data.items.forEach(item=>{
      const card = document.createElement("div");
      card.className="p-4 rounded-2xl border border-slate-200";
      card.innerHTML = `<div class="flex items-center justify-between">
        <div class="font-semibold text-sm text-slate-800">${item.title}</div>
        <div class="text-[11px] text-slate-500">${item.date}</div>
      </div>
      <p class="mt-1 text-xs text-slate-600">${item.body}</p>`;
      list.appendChild(card);
    });
  }catch(e){
    const empty = document.createElement("div");
    empty.className="text-xs text-slate-500";
    empty.textContent="Offline: showing last saved feed.";
    list.appendChild(empty);
    mockDB.feed.forEach(item=>{
      const card=document.createElement("div");
      card.className="p-4 rounded-2xl border border-slate-200";
      card.innerHTML=`<div class="flex items-center justify-between">
        <div class="font-semibold text-sm text-slate-800">${item.title}</div>
        <div class="text-[11px] text-slate-500">${item.date}</div></div>
        <p class="mt-1 text-xs text-slate-600">${item.body}</p>`;
      list.appendChild(card);
    });
  }
}

/* -------------------- Alerts -------------------- */
const alertsStore = [];
function addAlert(a){ alertsStore.unshift({ ...a, id: Date.now() }); }
function loadAlerts(){
  const wrap = $("#alertsList"); wrap.innerHTML="";
  if (alertsStore.length===0){
    addAlert({ title:"Check-in Reminder", ts:"Yesterday", body:"Daily check-in at 8pm.", type:"note" });
  }
  alertsStore.forEach(a=>{
    const card = document.createElement("div");
    card.className="p-4 rounded-2xl border border-slate-200";
    card.innerHTML = `<div class="flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">${a.title}</div>
      <div class="text-[11px] text-slate-500">${a.ts}</div>
    </div>
    <p class="text-xs text-slate-600 mt-1">${a.body}</p>`;
    wrap.appendChild(card);
  });
}

/* -------------------- Profile Toggles -------------------- */
const toggleCheckin=$("#toggleCheckin"), checkinKnob=$("#checkinKnob"), checkinHint=$("#checkinHint");
toggleCheckin.addEventListener("change", ()=>{
  if (toggleCheckin.checked){
    checkinKnob.style.left='1.375rem';
    checkinKnob.parentElement.style.background='rgba(16,185,129,.9)';
    show(checkinHint);
    addAlert({ title:"Check-in Enabled", ts:"Now", body:"Daily reminder set for 8pm.", type:"note" });
  } else {
    checkinKnob.style.left='.125rem';
    checkinKnob.parentElement.style.background='';
    hide(checkinHint);
    addAlert({ title:"Check-in Disabled", ts:"Now", body:"Reminders turned off.", type:"note" });
  }
});

/* -------------------- Chat (mock realtime) -------------------- */
async function loadMessages(){
  try{
    const res = await api.call("/api/messages",{ method:"GET" });
    const data = await res.json();
    return data.items;
  }catch(e){
    return mockDB.messages;
  }
}
function renderChat(){
  const wrap = $("#chatThread");
  wrap.innerHTML="";
  loadMessages().then(items=>{
    items.sort((a,b)=> a.ts-b.ts).forEach(m=>{
      const row = document.createElement("div");
      const mine = m.from==="you";
      row.className = "flex " + (mine ? "justify-end" : "justify-start");
      row.innerHTML = `<div class="max-w-[75%] px-3 py-2 rounded-2xl ${mine?'bg-blue-600 text-white':'bg-white border border-slate-200'}">
        <div class="text-xs">${escapeHtml(m.text)}</div>
        <div class="text-[10px] mt-1 opacity-80">${formatTime(m.ts)} ${mine? (m.read?'✓✓':'✓'):''}</div>
      </div>`;
      wrap.appendChild(row);
    });
    wrap.scrollTop = wrap.scrollHeight;
  });
}
$("#chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const input = $("#chatInput");
  const text = input.value.trim();
  if (!text) return;
  input.value="";
  try{
    await api.call("/api/messages",{ method:"POST", body: JSON.stringify({ text }) });
  }catch(e){
    // Offline local append
    mockDB.messages.push({ id: Date.now(), from:"you", text, ts: Date.now(), read:false });
  }
  renderChat();
});

/* -------------------- Calls (Audio/Video UI) -------------------- */
$("#openAudio").addEventListener("click", ()=>{
  go("call");
  $("#callTitle").textContent="Audio Call";
  hide($("#videoPreview"));
  hide($("#btnCam"));
  startCall({ video:false });
});
$("#openVideo").addEventListener("click", ()=>{
  go("call");
  $("#callTitle").textContent="Video Call";
  show($("#videoPreview"));
  show($("#btnCam"));
  startCall({ video:true });
});

let callActive=false, muted=false, camOn=true;
async function startCall(opts){
  callActive=true; muted=false; camOn=true;
  try{
    await api.call("/api/call",{ method:"POST", body: JSON.stringify({ type: opts.video?'video':'audio' }) });
  }catch(e){
    // offline: just UI
  }
}
$("#btnMute").addEventListener("click", ()=>{
  muted = !muted;
  $("#btnMute").textContent = muted? "Unmute":"Mute";
  toast(muted? "Muted":"Unmuted");
});
$("#btnCam").addEventListener("click", ()=>{
  camOn = !camOn;
  $("#btnCam").textContent = camOn? "Camera Off":"Camera On";
  $("#videoPreview").textContent = camOn? "Video Preview":"Camera Off";
});
$("#btnEnd").addEventListener("click", ()=>{
  callActive=false;
  go("dashboard");
  toast("Call ended");
});

/* -------------------- AI Safety Bot -------------------- */
$("#botFab").addEventListener("click", ()=> show($("#botPanel")));
$("#botClose").addEventListener("click", ()=> hide($("#botPanel")));
$("#botForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const input = $("#botInput");
  const text = input.value.trim();
  if (!text) return;
  const lang = $("#botLang").value;
  botAdd("you", text);
  input.value="";
  try{
    const res = await api.call("/api/ai-bot",{ method:"POST", body: JSON.stringify({ text, lang }) });
    const data = await res.json();
    botAdd("bot", data.reply);
  }catch(e){
    botAdd("bot", "(Offline) Here are basic tips: Keep belongings safe, use main roads, call local emergency numbers 100/112.");
  }
});
function botAdd(who, text){
  const wrap = $("#botMessages");
  const row = document.createElement("div");
  row.className = "flex "+(who==="you"?"justify-end":"justify-start");
  row.innerHTML = `<div class="max-w-[80%] px-3 py-2 rounded-2xl ${who==='you'?'bg-blue-600 text-white':'bg-white border border-slate-200'} text-xs">${escapeHtml(text)}</div>`;
  wrap.appendChild(row);
  wrap.scrollTop = wrap.scrollHeight;
}
function botLogic(text, lang){
  const t = text.toLowerCase();
  const tr = {
    EN:{
      lost:"Share your live location with guardians. Head to nearest police help desk or safe zone highlighted green.",
      hospital:"Nearest hospital pinned on map. If severe, dial Ambulance 102/108.",
      numbers:"Police 100 / 112, Ambulance 102/108, Fire 101.",
      tips:"Stay on lit roads, keep phone charged, save emergency contacts.",
      translate:"Emergency! I need help. = मदद कीजिए! मुझे मदद चाहिए।"
    },
    HI:{
      lost:"अपना लाइव लोकेशन अभिभावकों से साझा करें। निकटतम पुलिस सहायता डेस्क या हरे सुरक्षित क्षेत्र की ओर जाएँ।",
      hospital:"निकटतम अस्पताल मानचित्र पर चिन्हित है। गंभीर स्थिति में 102/108 पर कॉल करें।",
      numbers:"पुलिस 100 / 112, एम्बुलेंस 102/108, फायर 101.",
      tips:"रोशनी वाले मार्गों पर रहें, फोन चार्ज रखें, आपात संपर्क सुरक्षित रखें.",
      translate:"Emergency! I need help. = मदद कीजिए! मुझे मदद चाहिए।"
    }
  }[lang||"EN"];
  if (t.includes("lost")) return tr.lost;
  if (t.includes("hospital")) return tr.hospital;
  if (t.includes("number")) return tr.numbers;
  if (t.includes("tip")) return tr.tips;
  if (t.includes("translate") || t.includes("phrase")) return tr.translate;
  return lang==="HI" ? "मैं आपकी सहायता के लिए यहाँ हूँ। अधिक जानकारी दें।" : "I'm here to help. Tell me more.";
}

/* -------------------- Utilities -------------------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])) }
function formatTime(ts){ const d=new Date(ts); return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0"); }

/* -------------------- Back buttons -------------------- */
$$("[data-back='dashboard']").forEach(b=> b.addEventListener("click", ()=> go("dashboard")));
$$("[data-back='map']").forEach(b=> b.addEventListener("click", ()=> go("map")));

/* -------------------- Accessibility: increase hit-areas -------------------- */
$$("button").forEach(b=>{ if(!b.className.includes("py-")) b.classList.add("py-2"); });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f9185aa3db0bc9',t:'MTc1Nzk0OTQ5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
