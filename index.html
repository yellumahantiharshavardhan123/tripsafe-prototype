<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TripSafe â€“ Your Safety, Our Priority</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* --- your CSS unchanged --- */
</style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div id="app" class="w-full max-w-sm mx-auto bg-white rounded-3xl trust-card overflow-hidden">
    <!-- your full HTML content is unchanged -->
  </div>

<script>
/* -------------------- Supabase Setup -------------------- */
const SUPABASE_URL = "https://deueiegsmrmxgntqbtdo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRldWVpZWdzbXJteGdudHFidGRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTUyODYsImV4cCI6MjA3MzU3MTI4Nn0.W9QJRFcIIRZjpYK6QMyKX83qhNNut4of0P9EMOshtQA";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------- Auth -------------------- */
signupForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#suMobile").value + "@tripsafe.com"; 
  const password = $("#suOtp").value || "defaultPass123";
  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password,
    options: {
      data: {
        name: $("#suName").value,
        from: $("#suFrom").value,
        guardian: $("#suGuardian").value
      }
    }
  });
  if (error) toast(error.message);
  else { applyUser({ name: $("#suName").value, from: $("#suFrom").value }); go("dashboard"); toast("Account created!"); }
});

loginForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#loginTouristId").value + "@tripsafe.com";
  const password = $("#loginPassword").value || "defaultPass123";
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) { toast(error.message); return; }
  const user = data.user?.user_metadata || { name:"Traveler", from:"Unknown" };
  applyUser(user); 
  go("dashboard"); 
  toast("Welcome back!");
});

/* -------------------- SOS -------------------- */
$("#sosConfirm").addEventListener("click", async ()=>{
  hide($("#modalSOS"));
  const user = await supabaseClient.auth.getUser();
  const { error } = await supabaseClient.from("sos_alerts").insert([
    { user_id: user.data.user?.id, location: { lat: 18.5204, lng: 73.8567 } }
  ]);
  if (error) toast("Error: " + error.message);
  else { toast("SOS sent"); addAlert({ title:"SOS Sent", ts:"Now", body:"Shared with authorities & guardians", type:"warn" }); loadAlerts(); }
});

/* -------------------- Safety Feed -------------------- */
async function loadFeed(){
  const list = $("#feedList"); list.innerHTML="";
  const { data, error } = await supabaseClient.from("incidents").select("*").order("created_at",{ascending:false});
  if (error){ toast("Error loading feed"); return; }
  data.forEach(item=>{
    const card = document.createElement("div");
    card.className="p-4 rounded-2xl border border-slate-200";
    card.innerHTML = `<div class="flex items-center justify-between">
      <div class="font-semibold text-sm text-slate-800">${item.title}</div>
      <div class="text-[11px] text-slate-500">${new Date(item.created_at).toLocaleDateString()}</div>
    </div>
    <p class="mt-1 text-xs text-slate-600">${item.body}</p>`;
    list.appendChild(card);
  });
}

/* -------------------- Chat -------------------- */
$("#chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const text = $("#chatInput").value.trim();
  $("#chatInput").value="";
  const user = await supabaseClient.auth.getUser();
  await supabaseClient.from("messages").insert([{ user_id: user.data.user?.id, text, from_role:"tourist" }]);
});

async function renderChat(){
  const { data, error } = await supabaseClient.from("messages").select("*").order("created_at",{ascending:true});
  if (error) return;
  const wrap = $("#chatThread"); wrap.innerHTML="";
  data.forEach(m=>{
    const mine = m.from_role==="tourist";
    const row = document.createElement("div");
    row.className = "flex " + (mine ? "justify-end" : "justify-start");
    row.innerHTML = `<div class="max-w-[75%] px-3 py-2 rounded-2xl ${mine?'bg-blue-600 text-white':'bg-white border border-slate-200'}">
      <div class="text-xs">${m.text}</div>
    </div>`;
    wrap.appendChild(row);
  });
  wrap.scrollTop = wrap.scrollHeight;
}

supabaseClient.channel("messages")
  .on("postgres_changes",{ event:"INSERT", schema:"public", table:"messages" },
    payload => { renderChat(); })
  .subscribe();
</script>
</body>
</html>
